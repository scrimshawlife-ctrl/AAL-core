from aal_core.ers.baseline import compute_baseline_signature
from aal_core.ers.effects_store import EffectStore, record_effect
from aal_core.ers.stabilization import new_state
from abx_runes.tuning.plane.router import build_tuning_plane_bundle


def test_exploit_clamped_to_low_risk_knobs_only_under_drift_high():
    env = {
        "schema_version": "tuning-envelope/0.1",
        "module_id": "mod.alpha",
        "knobs": [
            {
                "name": "k_high",
                "kind": "enum",
                "enum_values": ["a", "b"],
                "default": "a",
                "hot_apply": True,
                "stabilization_cycles": 0,
                "capability_required": "cap.k_high",
                "risk_units": 2.0,
                "expected_latency_bump_ms_p95": 10.0,
            },
            {
                "name": "k_low",
                "kind": "enum",
                "enum_values": ["a", "b"],
                "default": "a",
                "hot_apply": True,
                "stabilization_cycles": 0,
                "capability_required": "cap.k_low",
                "risk_units": 0.2,
                "expected_latency_bump_ms_p95": 1.0,
            },
        ],
    }
    reg = {"mod.alpha": {"tuning_envelope": env, "node_id": "node.alpha"}}

    # Provide baseline-bearing metrics so effects are bucketed the same way the router will bucket.
    root_metrics = {"queue_depth": 5, "input_size": 500, "time_window": "peak"}
    baseline = compute_baseline_signature(root_metrics)

    store = EffectStore()
    # Make "b" the best choice for both knobs in this baseline bucket.
    record_effect(
        store,
        module_id="mod.alpha",
        knob="k_low",
        value="b",
        baseline_signature=baseline,
        before_metrics={"latency_ms_p95": 100.0},
        after_metrics={"latency_ms_p95": 90.0},
    )
    record_effect(
        store,
        module_id="mod.alpha",
        knob="k_high",
        value="b",
        baseline_signature=baseline,
        before_metrics={"latency_ms_p95": 100.0},
        after_metrics={"latency_ms_p95": 80.0},
    )

    prev = {"__global__": {"latency_ms_p95": 100.0, "error_rate": 0.01, "cost_units": 10.0, "throughput_per_s": 100.0}}
    now = {"__global__": {**root_metrics, "latency_ms_p95": 140.0, "error_rate": 0.02, "cost_units": 11.0, "throughput_per_s": 95.0}}

    policy = {
        "prev_metrics_snapshot": prev,
        "enable_explore": True,
        "drift_high_threshold": 0.01,  # force drift_high clamp
        "drift_extreme_threshold": 0.99,
        "clamped_max_changes_per_cycle": 2,
        "clamped_max_total_risk_units": 0.5,
        "clamped_max_latency_bump_ms_p95": 2.0,
    }

    b = build_tuning_plane_bundle(
        source_cycle_id="c",
        registry_snapshot=reg,
        metrics_snapshot=now,
        effects_store=store,
        stabilization_state=new_state(),
        policy=policy,
    )

    assert b["decisions"]["do_nothing"] is False
    assert b["decisions"]["risk_policy"]["max_total_risk_units"] == 0.5

    irs = b["tuning_irs"]
    assert len(irs) == 1
    assigns = irs[0]["assignments"]
    # High risk knob should be clamped out even though it has better effect stats.
    assert "k_high" not in assigns
    assert assigns["k_low"] == "b"

