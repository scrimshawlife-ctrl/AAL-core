{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aal.local/schema/MetricBindingSpec.v0.1",
  "title": "MetricBindingSpec.v0.1",
  "type": "object",
  "required": ["schema", "channels"],
  "properties": {
    "schema": { "const": "MetricBindingSpec.v0.1" },
    "channels": {
      "type": "object",
      "required": ["R", "C", "S", "N", "K"],
      "properties": {
        "R": { "$ref": "#/$defs/channel_rule" },
        "S": { "$ref": "#/$defs/channel_rule" },
        "N": { "$ref": "#/$defs/channel_rule" },
        "K": { "$ref": "#/$defs/channel_rule" },
        "C": { "$ref": "#/$defs/vector_rule" }
      },
      "additionalProperties": false
    },
    "defaults": {
      "type": "object",
      "properties": {
        "R": { "type": "number" },
        "S": { "type": "number" },
        "N": { "type": "number" },
        "K": { "type": "number" },
        "C": { "type": "array", "items": { "type": "number" }, "minItems": 6, "maxItems": 6 }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "selector": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "enum": ["name", "pattern", "tag"] },
        "value": { "type": "string" },
        "path": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },
    "transform": {
      "type": "object",
      "properties": {
        "op": { "enum": ["identity", "clip01", "minmax", "log1p", "sigmoid", "zscore_if_stats"] },
        "min": { "type": ["number", "null"] },
        "max": { "type": ["number", "null"] }
      },
      "additionalProperties": false
    },
    "channel_rule": {
      "type": "object",
      "required": ["candidates"],
      "properties": {
        "candidates": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/selector" } },
        "transform": { "$ref": "#/$defs/transform" },
        "fallback": { "type": "number" }
      },
      "additionalProperties": false
    },
    "vector_rule": {
      "type": "object",
      "required": ["candidates", "length"],
      "properties": {
        "length": { "type": "integer", "const": 6 },
        "candidates": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/selector" } },
        "transform": { "$ref": "#/$defs/transform" },
        "fallback": { "type": "array", "items": { "type": "number" }, "minItems": 6, "maxItems": 6 }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
